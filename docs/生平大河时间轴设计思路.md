## 项目背景与目标

本设计文档围绕 `chronology_full.csv`（基于《黄宾虹年谱》抽取的编年体数据），规划一个与“交游模块”（墨海星图 / 蜀游长卷）风格统一的**生平大河式时间轴 + 主题筛选**视图，用于宏大叙事地呈现大师一生。

- **技术栈**: Vue 3 + 静态数据（CSV/JSON）+ SVG（或 Canvas）
- **对齐现有模块**:
  - 借鉴 `FriendsNetwork.vue` 的**多标签页布局**和“专题视图”概念；
  - 借鉴 `InkSeaMap.vue` 的**水墨视觉、垂直汉字、时间滑杆**与“卡片叙事”；
  - 避免依赖后端，可在无后端环境下完整运行。

核心问题：**在时间维度上，如何从“一条条事件”上升为“有起伏的大叙事大河”？**

---

## 体验概览

### 视图角色

- **生平大河视图（Life River View）**：本设计文档的主角，将作为“生平”大模块下的一个子视图，风格上与“墨海星图 / 蜀游长卷 / 好友时轴”并列。
- 与 `FriendsNetwork.vue` 的标签设计类似，可通过上方标签在以下视图中切换：
  - 墨海星图（空间+关系）  
  - 蜀游长卷（单次壮游的线路叙事）  
  - 好友时轴（交游局部时间线）  
  - **生平大河**（本设计：一生的整体时间叙事）

### 核心交互

- **大河时间轴**：  
  - 横轴 = 年份（1865–1955）  
  - 纵轴 = “重要度”或“事件密度”（由 `Social_Weight` 聚合而来）  
  - 形成一条起伏的“人生大河”曲线或面积图。

- **主题筛选（多视角看一生）**：
  - 支持切换 / 叠加不同主题：如“学业与科举”“行旅与山水”“师承与交游”“创作与鉴藏”“时代与政局”“家族与日常”等；
  - 选中主题后，大河只基于该主题相关事件重算高度与颜色；
  - 下方年份详情只显示对应主题的事件卡片。

- **年份详情 & 叙事卡片**：
  - 点击某一年：在下方出现该年事件的卡片列表，按主题分组；
  - 卡片样式参考“蜀游长卷”的 `tiba-card-refined`：印章式地点/标签 + 主叙事文本 + 补充元信息；
  - 后续可扩展为“三重视图”：事件摘要 + 作品/文献 + 证据引文。

---

## 数据设计

### 1. 源数据：`chronology_full.csv`

关键字段：

- **Event_ID**: 事件唯一 ID
- **Exact_Date**: 精确日期或模糊日期（如 `1874.春`）
- **Master_Location**: 主要地点（如 金华 / 歙县 / 南京 / 扬州 / 北平 / 杭州 / 四川 等）
- **Primary_Figure**: 主要人物（目前多为空，后续可用于构建人物网络）
- **Subject_Action**: 行为类别（活动 / 紀游 / 書信 / 聘任 / 位移 / 雅集 / ……）
- **Summary_Text**: 精简叙事摘要
- **Details_Evidence**: 史料出处 + 详细引文（学术级支撑）
- **Artifact_Refs**: 作品 / 文献 / 印谱等引用
- **Social_Weight**: 社会权重 / 重要度评分（数字）

### 2. 前端标准化模型

```ts
type ChronologyEvent = {
  id: string;              // Event_ID
  year: number;            // 从 Exact_Date 解析
  month?: number | null;
  day?: number | null;
  rawDate: string;         // 原始 Exact_Date 字符串
  location: string | null; // Master_Location
  action: string;          // Subject_Action
  summary: string;         // Summary_Text
  details: string;         // Details_Evidence
  artifacts: string[];     // Artifact_Refs 拆成数组
  socialWeight: number;    // Social_Weight
  themes: string[];        // 后续打上的主题标签
};
```

日期解析约定：

- `1865.01.27` → `year=1865, month=1, day=27`
- `1874.春` / `1890.夏` 等模糊日期，仅取 `year`，`month/day = null`；
- 大河渲染以“年”为主轴，不强依赖 `month/day`。

### 3. 年度聚合结构：大河的基本单位

```ts
type YearBucket = {
  year: number;
  events: ChronologyEvent[];   // 该年所有事件
  totalWeight: number;         // sum(socialWeight)
  maxWeight: number;           // 该年单条最高 Social_Weight
  byTheme: Record<string, {
    count: number;
    totalWeight: number;
  }>;
};
```

构建逻辑（伪代码）：

```js
function buildYearBuckets(events: ChronologyEvent[]): YearBucket[] {
  const map = new Map();

  for (const ev of events) {
    if (!map.has(ev.year)) {
      map.set(ev.year, {
        year: ev.year,
        events: [],
        totalWeight: 0,
        maxWeight: 0,
        byTheme: {}
      });
    }
    const bucket = map.get(ev.year);
    bucket.events.push(ev);
    const w = ev.socialWeight || 0;
    bucket.totalWeight += w;
    bucket.maxWeight = Math.max(bucket.maxWeight, w);

    for (const theme of ev.themes) {
      if (!bucket.byTheme[theme]) {
        bucket.byTheme[theme] = { count: 0, totalWeight: 0 };
      }
      bucket.byTheme[theme].count += 1;
      bucket.byTheme[theme].totalWeight += w;
    }
  }

  return Array.from(map.values()).sort((a, b) => a.year - b.year);
}
```

---

## 主题体系与打标

### 1. 主题枚举

新建 `src/config/chronologyThemes.js`：

```js
export const THEMES = [
  { id: 'education', label: '学业与科举',   color: '#2c7be5' },
  { id: 'travel',    label: '行旅与山水',   color: '#00b894' },
  { id: 'teachers',  label: '师承与交游',   color: '#fd9644' },
  { id: 'creation',  label: '创作与鉴藏',   color: '#9b59b6' },
  { id: 'politics',  label: '时代与政局',   color: '#e74c3c' },
  { id: 'family',    label: '家族与日常',   color: '#34495e' }
];
```

### 2. 主题打标规则（前端可实现）

- 基于 `Subject_Action` + `Summary_Text` + `Details_Evidence` 的简单规则：
  - **education**:
    - `Subject_Action` 含：`書信`（科举相关）、`聘任`（书院 / 学校）、`應試` 等；
    - 文本中出现：“童子试”“府试”“院试”“书院”“讲学”“主讲”“科举”。
  - **travel**:
    - `Subject_Action` 含：`紀游`、`位移`；
    - 文本中出现大量地名 + “游”“至某地”“行”“旅”“登山”“写生”等。
  - **teachers**:
    - 文本中出现“从 X 问学”“拜 X 为师”“某某为师”“门人”“弟子”“传法”等。
  - **creation**:
    - 出现“作画”“刻印”“藏书”“鉴定”“画展”“印谱”“写生册”等。
  - **politics**:
    - 出现“战争”“革命”“起义”“太平军”“甲午”“抗战”“政局”“官职”等。
  - **family**:
    - 出现“父亲 / 母亲 / 祖父 / 祖母 / 兄弟 / 妻 / 子女 / 家道 / 葬 / 婚 / 迁居”等。

- 一个事件可属于多个主题：`themes: string[]`。
- 实现方式：
  - 在解析 CSV 后，对每条 `ChronologyEvent` 调用 `assignThemes(ev)`；
  - 初期先用简单关键字规则，后续可以在 CSV 旁边维护一份人工修正表覆盖默认结果。

---

## 视图布局与交互（对齐交游模块）

### 1. 总体布局

参考 `FriendsNetwork.vue` 的结构：

- 顶部保留**雅致标签栏**，新加一个入口：
  - `墨海星圖 | 蜀游長卷 | 好友時軸 | 生平大河`
- 下部主视图结构：
  - 上半：**大河图（RiverChart）**
  - 中部：**年份详情面板（YearDetailPanel）**
  - 底部：**主题筛选条（ThemeFilterBar）** 和迷你时间范围控制

```text
┌───────────────────────────────┐
│ 交游标签：墨海星圖 / 蜀游長卷 / 好友時軸 / 生平大河 │
├───────────────────────────────┤
│           大河时间轴（RiverChart）         │
├───────────────────────────────┤
│         年份详情 + 事件卡片（YearDetail）   │
├───────────────────────────────┤
│   主题筛选条（ThemeFilterBar） + 范围缩放    │
└───────────────────────────────┘
```

### 2. 大河时间轴（RiverChart）设计

- **绘制方式**:
  - 使用 SVG `<path>` 绘制平滑折线 + 下方填充区域，类似当前时间线水墨曲线；
  - 高度映射：
    - `visibleWeight(year) = f(totalWeight 或 选中主题的 totalWeight)`；
    - 建议 `height = log(1 + visibleWeight)` 或 `sqrt`，避免极端年份过高。

- **颜色体系**（对齐 InkSeaMap 的水墨气质）:
  - 基色采用低饱和棕黑 / 墨绿；
  - 若无主题筛选：单色墨线（类似 Timeline 的 `#8e682f` / `#e67e22` 渐变）；
  - 有主题筛选：用主题色作为主色，并加轻微水墨滤镜（可沿用 `#ink-filter` 思路）。

- **交互**:
  - `hover` 某年：显示 tooltip：
    - 年份
    - 本年事件总数
    - 按主题的占比小条图（用小方块或条状表示）。
  - `click` 某年：触发年份详情更新（滚动到中部面板）。
  - 支持鼠标滚轮横向滚动（复用 TimelinePage 的 `wheel` 处理思路）。

### 3. 年份详情面板（YearDetailPanel）

- 行为：
  - 显示当前选中 year 对应的 `YearBucket.events`，仅保留与当前主题筛选有交集的事件。
  - 按主题分组呈现，每个主题一列或一块，类似蜀游长卷中水平排列的 `tiba-card-refined` 卡片。

- 卡片设计（对齐“蜀游长卷”）：
  - 上方小印章：主题名 / 地点（类比 `tiba-stamp-red`）
  - 主体：`Summary_Text` 作为主描述，控制在 2–3 行；
  - 底部元信息：`Exact_Date` / `Master_Location` / 来源缩写（从 `Details_Evidence` 中抽第一个来源名）。

- 点击卡片：
  - 可展开“更多”层，展示：
    - 更完整的 `Details_Evidence` 片段；
    - `Artifact_Refs` 映射到的作品 / 文献缩略信息（待后续数据接入）。

### 4. 主题筛选条（ThemeFilterBar）

- 外观参考 `nav-tab-ya` 风格：
  - 采用**细长标签按钮**，横向排列；
  - 选中主题高亮（底线 + 深色字体），未选主题半透明。

- 行为：
  - 单击：选中 / 取消某主题；
  - 可配置为“多选模式”（推荐，支持多视角叠加）；
  - 选中主题集合存储于父组件的 `selectedThemes: string[]`。

- 状态对大河和详情的影响：
  - 若 `selectedThemes` 为空：大河基于 `totalWeight`；
  - 若不为空：大河基于所选主题的 `sum(byTheme[theme].totalWeight)`；
  - 年份详情只展示 `event.themes` 与 `selectedThemes` 有交集的事件。

### 5. 时间范围缩放

- 在大河下方使用一个简化的「迷你时间轴」：
  - 展示 1865–1955 全局淡色折线；
  - 拖动一个左右滑块控制当前主视图的可视范围（例如只看 1930–1955）。

---

## 组件划分与状态流转

### 1. 顶层组件：`LifeRiverView.vue`

**职责**：

- 加载并解析 `chronology_full.csv`；
- 为每个事件打主题标签 `themes`；
- 构建 `YearBucket[]`；
- 管理：
  - 当前选中年份 `selectedYear`
  - 当前主题筛选 `selectedThemes[]`
  - 当前时间范围 `visibleRange = { startYear, endYear }`

**关键 data / computed（示意）**：

```js
data() {
  return {
    rawEvents: [],
    yearBuckets: [],
    selectedYear: null,
    selectedThemes: [],
    visibleRange: { start: 1865, end: 1955 },
    loading: true
  };
},
computed: {
  visibleBuckets() {
    return this.yearBuckets.filter(
      b => b.year >= this.visibleRange.start && b.year <= this.visibleRange.end
    );
  }
}
```

### 2. `RiverChart.vue`

**props**：

- `buckets: YearBucket[]`
- `selectedThemes: string[]`
- `visibleRange: { start: number; end: number }`

**emits**：

- `select-year(year: number)`

**内部逻辑**：

- 根据 `selectedThemes` 计算 `visibleWeight(year)` 并绘制 path；
- 处理 hover/click 并通过事件通知父组件。

### 3. `YearDetailPanel.vue`

**props**：

- `yearBucket: YearBucket | null`
- `selectedThemes: string[]`

**行为**：

- 无 `yearBucket` 时展示简洁提示（如“请点击时间轴上的某一年”）；
- 有 `yearBucket` 时：
  - 将 `yearBucket.events` 过滤出与 `selectedThemes` 匹配的事件；
  - 再按主题分组，渲染卡片。

### 4. `ThemeFilterBar.vue`

**props**：

- `themes = THEMES`
- `selectedThemes: string[]`

**emits**：

- `update:selectedThemes(newSelected: string[])`

**行为**：

- 参考 `FriendsNetwork.vue` 的标签 UI，使视觉统一。

---

## 实现顺序建议

1. **数据接入与 YearBucket 构建**
   - 使用简单 CSV 解析（例如 `d3.csv` 或手写 parser）读取 `chronology_full.csv`；
   - 将每行映射为 `ChronologyEvent`；
   - 实现基础的 `assignThemes`（哪怕只用 `Subject_Action` 分一两类主题）；
   - 构建并打印 `YearBucket[]`，检查数值是否合理。

2. **第一版大河时间轴**
   - 实现 `RiverChart.vue`，只基于 `totalWeight` 绘制单色折线 + 填充；
   - 支持 hover + click，日志输出选中年份。

3. **主题筛选与高度重算**
   - 接入 `ThemeFilterBar.vue`；
   - 根据 `selectedThemes` 切换大河高度计算方式；
   - 年份详情仅显示匹配主题的事件。

4. **年份详情卡片（对齐蜀游长卷风格）**
   - 设计事件卡片（印章 + 主文本 + 元信息），保持与 `FriendsNetwork` 中“蜀游长卷”卡片统一的视觉语言；
   - 支持展开/折叠详细证据。

5. **微调视觉与动效**
   - 应用水墨滤镜、字体（行楷 / 楷体）、竖排标签等；
   - 根据性能情况适当优化 SVG path 计算与重绘节奏。

---

## 与后续扩展的接口

- **与交游数据的联动**：
  - 将来可在点击某一年时，让 `InkSeaMap` / “好友时轴”联动到该年的人物与关系。

- **与作品数据库的联动**：
  - `Artifact_Refs` 可作为桥梁，点击某事件可跳转到对应作品详情 / 图像视图。

- **与现有 TimelinePage 的关系**：
  - 本视图偏重“**编年体 + 主题切片 + 全人生视角**”；
  - 现有 `TimelinePage.vue` 更偏“**视觉化时间线 + 生平 & 史事并置**”；
  - 两者可以并存：前者是“概览”和“数据驱动”，后者是“视觉特写”。

